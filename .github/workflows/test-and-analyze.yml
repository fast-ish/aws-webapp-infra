name: Code Quality & Security

on:
  workflow_dispatch:
  schedule:
    # run at 9:00 am utc every monday
    - cron: '0 9 * * 1'

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'corretto'

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

jobs:
  build-cdk-common:
    name: Build CDK Common Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CDK Common
        uses: actions/checkout@v4
        with:
          repository: fast-ish/cdk-common
          path: cdk-common
          ref: main

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      - name: Build and install cdk-common
        run: |
          cd cdk-common
          mvn clean install -DskipTests -B

      - name: Upload cdk-common artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cdk-common-build
          path: ~/.m2/repository/fastish/cdk-common/
          retention-days: 1

  build-and-test:
    name: build and test
    runs-on: ubuntu-latest
    needs: build-cdk-common

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: set up jdk ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Download cdk-common artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-common-build
          path: ~/.m2/repository/

      - name: compile project
        run: mvn clean compile -B

      - name: run tests
        run: mvn test -B || true

      - name: generate test report
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: maven tests
          path: '**/target/surefire-reports/*.xml'
          reporter: java-junit
          fail-on-error: false

      - name: upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results
          path: '**/target/surefire-reports/'
          retention-days: 7

  code-coverage:
    name: code coverage analysis
    runs-on: ubuntu-latest
    needs: build-cdk-common

    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: set up jdk ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Download cdk-common artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-common-build
          path: ~/.m2/repository/

      - name: run tests with JaCoCo coverage
        run: mvn clean test jacoco:report -B || true

      - name: generate jacoco badge
        id: jacoco
        uses: cicirello/jacoco-badge-generator@v2
        with:
          generate-branches-badge: true
          jacoco-csv-file: infra/target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-coverage-endpoint: true
          coverage-endpoint-filename: jacoco.json
        continue-on-error: true

      - name: upload jacoco coverage report
        uses: actions/upload-artifact@v5
        with:
          name: jacoco-report
          path: infra/target/site/jacoco/
          retention-days: 7

      - name: comment pr with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.jacoco.outputs.coverage }}';
            const branch = '${{ steps.jacoco.outputs.branches }}';
            const body = `## ðŸ“Š Code Coverage Report

            - **Overall Coverage:** ${coverage}%
            - **Branch Coverage:** ${branch}%

            View the full report in the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  spotbugs-analysis:
    name: spotbugs static analysis
    runs-on: ubuntu-latest
    needs: build-cdk-common

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up jdk ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Download cdk-common artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-common-build
          path: ~/.m2/repository/

      - name: run spotbugs analysis
        run: |
          mvn clean compile spotbugs:spotbugs -B || true
          mvn spotbugs:check -B || true

      - name: upload spotbugs report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: spotbugs-report
          path: infra/target/spotbugsXml.xml
          retention-days: 7

      - name: parse spotbugs results
        if: always()
        uses: jwgmeligmeyling/spotbugs-github-action@v1.2
        with:
          path: infra/target/spotbugsXml.xml
          name: spotbugs

  pmd-analysis:
    name: pmd static analysis
    runs-on: ubuntu-latest
    needs: build-cdk-common

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up jdk ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Download cdk-common artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-common-build
          path: ~/.m2/repository/

      - name: run pmd analysis
        run: |
          mvn clean compile pmd:pmd pmd:cpd -B || true
          mvn pmd:check cpd:check -B || true

      - name: upload pmd report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: pmd-report
          path: |
            infra/target/pmd.xml
            infra/target/cpd.xml
          retention-days: 7

      - name: publish pmd results
        if: always() && github.actor != 'dependabot[bot]'
        uses: jwgmeligmeyling/pmd-github-action@v1.2
        with:
          path: infra/target/pmd.xml
          name: pmd
        continue-on-error: true

  checkstyle-analysis:
    name: checkstyle analysis
    runs-on: ubuntu-latest
    needs: build-cdk-common

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up jdk ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Download cdk-common artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-common-build
          path: ~/.m2/repository/

      - name: run checkstyle
        run: mvn clean checkstyle:checkstyle -B || true

      - name: upload checkstyle report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: checkstyle-report
          path: infra/target/checkstyle-result.xml
          retention-days: 7

      - name: publish checkstyle results
        if: always() && github.actor != 'dependabot[bot]'
        uses: jwgmeligmeyling/checkstyle-github-action@v1.2
        with:
          path: infra/target/checkstyle-result.xml
          name: checkstyle
        continue-on-error: true

  dependency-check:
    name: owasp dependency check
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up jdk ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: run owasp dependency check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'aws-webapp-infra'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
        continue-on-error: true

      - name: upload dependency check results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 7

  dependency-analysis:
    name: maven dependency analysis
    runs-on: ubuntu-latest
    needs: build-cdk-common

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up jdk ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Download cdk-common artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-common-build
          path: ~/.m2/repository/

      - name: analyze dependencies
        run: |
          mvn dependency:analyze -B || true
          mvn dependency:analyze-duplicate -B || true
          mvn dependency:analyze-dep-mgt -B || true

      - name: check for dependency updates
        run: mvn versions:display-dependency-updates -B

      - name: check for plugin updates
        run: mvn versions:display-plugin-updates -B

  quality-gate:
    name: quality gate
    runs-on: ubuntu-latest
    needs: [ build-and-test, code-coverage, spotbugs-analysis, pmd-analysis, checkstyle-analysis ]
    if: always()

    steps:
      - name: check quality gate status
        run: |
          echo "## ðŸ” Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build and Test | ${{ needs.build-and-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | ${{ needs.code-coverage.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SpotBugs | ${{ needs.spotbugs-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PMD | ${{ needs.pmd-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkstyle | ${{ needs.checkstyle-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-and-test.result }}" == "failure" ]]; then
            echo "âŒ **Quality Gate Failed:** Build and tests must pass" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **Quality Gate Passed**" >> $GITHUB_STEP_SUMMARY
          fi
